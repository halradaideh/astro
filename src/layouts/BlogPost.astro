---
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Navigation.astro';
import Footer from '../components/Footer.astro';
import Comments from '../components/Comments.astro';
import FloatingStats from '../components/FloatingStats.astro';
import ThemeScript from '../components/ThemeScript.astro';

type Props = CollectionEntry<'blog'>['data'];

const { title, description, pubDate, updatedDate, heroImage } = Astro.props;
const currentPath = Astro.url.pathname;

// Format dates safely
const formatDate = (date: Date | string | undefined) => {
  if (!date) return '';
  const dateObj = date instanceof Date ? date : new Date(date);
  return dateObj.toLocaleDateString('en-us', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
  });
};

const formatISODate = (date: Date | string | undefined) => {
  if (!date) return '';
  try {
    const dateObj = date instanceof Date ? date : new Date(date);
    return dateObj.toISOString();
  } catch (e) {
    return '';
  }
};
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={title} description={description} />
    <ThemeScript />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={description} />
  </head>

  <body>
    <Header />
    <div class="page-content">
      <main>
        <article>
          <div class="hero-image">
            {heroImage && <img width={1020} height={510} src={heroImage} alt="" />}
          </div>
          <div class="prose">
            <div class="title">
              <div class="date">
                {pubDate && <time datetime={formatISODate(pubDate)}>{formatDate(pubDate)}</time>}
                {
                  updatedDate && (
                    <div class="last-updated-on">
                      Last updated on{' '}
                      <time datetime={formatISODate(updatedDate)}>{formatDate(updatedDate)}</time>
                    </div>
                  )
                }
              </div>
              <h1>{title}</h1>
              <hr />
            </div>
            <slot />
            <Comments />
          </div>
        </article>
      </main>
      <FloatingStats path={currentPath} />
      <Footer />
    </div>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family:
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          'Segoe UI',
          Roboto,
          Oxygen,
          Ubuntu,
          Cantarell,
          'Open Sans',
          'Helvetica Neue',
          sans-serif;
        background: var(--bg-color);
        color: var(--text-color);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      html {
        background: var(--bg-color);
      }

      .page-content {
        flex: 1;
        background: var(--bg-color);
        width: 100%;
        margin-top: 2rem;
        padding: 2rem 0;
        display: flex;
        flex-direction: column;
      }

      main {
        width: 90%;
        max-width: none;
        margin: 0 auto;
        padding: 0;
        flex: 1;
        box-sizing: border-box;
        background: var(--blog-container-bg);
        box-shadow: 0 -4px 12px var(--shadow-color);
        border-top: 1px solid var(--border-color);
        border-radius: 8px;
      }

      article {
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        padding: 2rem;
      }

      .hero-image {
        width: 100%;
        max-width: none;
        margin: 0 auto 3rem auto;
        padding: 2rem;
        background: transparent;
        border-radius: 12px;
      }

      .hero-image img {
        width: auto;
        max-width: 100%;
        height: auto;
        max-height: 400px;
        object-fit: contain;
        margin: 0 auto;
        display: block;
      }

      .prose {
        width: 100%;
        max-width: 100%;
        margin: auto;
        padding: 2rem;
        color: var(--text-color);
        font-size: 1.1rem;
        line-height: 1.7;
        box-sizing: border-box;
      }

      .prose :global(h1),
      .prose :global(h2),
      .prose :global(h3),
      .prose :global(h4),
      .prose :global(h5),
      .prose :global(h6) {
        color: var(--heading-color);
        margin: 1.5em 0 0.5em 0;
        width: 100%;
        max-width: 100%;
      }

      .prose :global(p) {
        color: var(--text-color);
        margin: 1.5em 0;
        width: 100%;
        max-width: 100%;
      }

      .prose :global(ul),
      .prose :global(ol) {
        width: 100%;
        max-width: 100%;
        margin: 1em 0;
        padding-left: 1.5em;
        box-sizing: border-box;
      }

      .prose :global(a) {
        color: var(--accent-color);
        text-decoration: none;
      }

      .prose :global(a:hover) {
        text-decoration: underline;
      }

      .title {
        margin-bottom: 2em;
        padding: 1em 0;
        text-align: center;
        line-height: 1;
      }

      .title h1 {
        margin: 0 0 0.5em 0;
        font-size: 2.5rem;
        color: var(--heading-color);
      }

      .date {
        margin-bottom: 0.5em;
        color: var(--text-muted);
      }

      .last-updated-on {
        font-style: italic;
        margin-top: 0.5em;
        color: var(--text-muted);
      }

      hr {
        border: none;
        border-top: 1px solid var(--border-color);
        margin: 2rem 0;
      }

      .prose :global(code) {
        font-family: 'Fira Code', monospace;
        font-size: 0.9em;
      }

      .prose :global(img) {
        max-width: 100%;
        height: auto;
      }

      .prose :global(blockquote) {
        border-left: 4px solid var(--accent-color);
        margin: 0;
        padding-left: 1em;
        color: var(--text-muted);
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
      }

      .prose :global(li) {
        margin: 0.5em 0;
        width: 100%;
        max-width: 100%;
      }

      .prose :global(pre) {
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        background-color: var(--code-bg) !important;
        padding: 1em;
        border-radius: 8px;
        overflow-x: auto;
      }

      .prose :global(pre.astro-code) {
        background-color: var(--code-bg) !important;
      }

      .prose :global(.astro-code) {
        background-color: var(--code-bg) !important;
        color: var(--code-color) !important;
      }

      .prose :global(table) {
        width: 100%;
        border-collapse: collapse;
        margin: 2em 0;
        overflow-x: auto;
        display: block;
        font-size: 0.9em;
      }

      .prose :global(thead) {
        display: table-header-group;
      }

      .prose :global(tbody) {
        display: table-row-group;
      }

      .prose :global(tr) {
        display: table-row;
      }

      .prose :global(th),
      .prose :global(td) {
        display: table-cell;
        padding: 0.75em 1em;
        border: 1px solid var(--border-color);
        text-align: left;
      }

      .prose :global(th) {
        background-color: var(--accent-color);
        color: white;
        font-weight: bold;
      }

      .prose :global(tbody tr:nth-child(even)) {
        background-color: var(--hover-bg);
      }

      @media (max-width: 1024px) {
        article {
          padding: 1.5rem;
        }

        .prose {
          padding: 1.5rem;
        }
      }

      @media (max-width: 768px) {
        article {
          padding: 1rem;
        }

        .prose {
          font-size: 1rem;
          padding: 1rem;
        }

        .title h1 {
          font-size: 2rem;
        }

        .hero-image {
          padding: 1rem;
          margin-bottom: 2rem;
        }

        .prose :global(table) {
          font-size: 0.8em;
        }

        .prose :global(th),
        .prose :global(td) {
          padding: 0.5em;
        }
      }

      @media (max-width: 480px) {
        article {
          padding: 0.5rem;
        }

        .prose {
          padding: 0.5rem;
          font-size: 0.95rem;
        }

        .title h1 {
          font-size: 1.75rem;
        }

        .hero-image {
          padding: 0.75rem;
        }
      }
    </style>
  </body>
</html>
