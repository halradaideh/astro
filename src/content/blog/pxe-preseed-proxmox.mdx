---
title: 'Automated Proxmox Deployment with PXE and Preseed'
description: 'Learn how to set up automated Proxmox deployments using PXE boot and Preseed configurations for efficient infrastructure management'
pubDate: '2024-03-22'
heroImage: '/blog-placeholder-5.jpg'
tags: ['proxmox', 'pxe', 'automation', 'infrastructure']
---

# Automated Proxmox Deployment with PXE and Preseed

Setting up a new Proxmox server typically involves manual installation steps. However, by combining PXE boot with Preseed configurations, we can automate the entire deployment process. This guide walks through setting up an automated Proxmox deployment system.

## Understanding the Components

### 1. PXE (Preboot Execution Environment)
- Network booting protocol
- Allows computers to boot from network
- Requires DHCP and TFTP servers

### 2. Preseed
- Debian's automated installation method
- Provides answers to installation questions
- Supports custom scripts and configurations

### 3. Proxmox VE
- Open-source virtualization platform
- Based on Debian
- Supports KVM and containers

## Setting Up the Infrastructure

### 1. DHCP Server Configuration

Using ISC DHCP Server:

```conf
# /etc/dhcp/dhcpd.conf

allow booting;
allow bootp;

subnet 192.168.1.0 netmask 255.255.255.0 {
    range 192.168.1.100 192.168.1.200;
    option routers 192.168.1.1;
    option domain-name-servers 8.8.8.8, 8.8.4.4;
    
    # PXE boot configuration
    filename "pxelinux.0";
    next-server 192.168.1.10; # TFTP server IP
}
```

### 2. TFTP Server Setup

Install and configure TFTP server:

```bash
# Install TFTP server
apt-get install tftpd-hpa

# Configure TFTP
cat > /etc/default/tftpd-hpa << EOF
TFTP_USERNAME="tftp"
TFTP_DIRECTORY="/srv/tftp"
TFTP_ADDRESS="0.0.0.0:69"
TFTP_OPTIONS="--secure"
EOF

# Create required directories
mkdir -p /srv/tftp/pxelinux.cfg
```

### 3. PXE Boot Files

Download and configure PXE boot files:

```bash
# Download required files
cd /srv/tftp
wget http://ftp.debian.org/debian/dists/bullseye/main/installer-amd64/current/images/netboot/netboot.tar.gz
tar xzf netboot.tar.gz

# Configure PXE menu
cat > pxelinux.cfg/default << EOF
DEFAULT proxmox
TIMEOUT 100
PROMPT 0

LABEL proxmox
    KERNEL debian-installer/amd64/linux
    APPEND initrd=debian-installer/amd64/initrd.gz auto=true priority=critical preseed/url=http://192.168.1.10/proxmox-preseed.cfg
EOF
```

## Preseed Configuration

Create a comprehensive Preseed configuration for Proxmox:

```ini
# /var/www/html/proxmox-preseed.cfg

# Localization
d-i debian-installer/locale string en_US
d-i keyboard-configuration/xkb-keymap select us

# Network configuration
d-i netcfg/choose_interface select auto
d-i netcfg/get_hostname string proxmox
d-i netcfg/get_domain string local

# Mirror settings
d-i mirror/country string manual
d-i mirror/http/hostname string ftp.debian.org
d-i mirror/http/directory string /debian
d-i mirror/http/proxy string

# Account setup
d-i passwd/root-password password your_secure_password
d-i passwd/root-password-again password your_secure_password
d-i passwd/make-user boolean false

# Partitioning
d-i partman-auto/method string regular
d-i partman-auto/choose_recipe select atomic
d-i partman-partitioning/confirm_write_new_label boolean true
d-i partman/choose_partition select finish
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true

# Package selection
tasksel tasksel/first multiselect standard
d-i pkgsel/include string openssh-server python3 sudo

# Proxmox repository setup
d-i preseed/late_command string \
    in-target wget -O- "http://enterprise.proxmox.com/debian/proxmox-release-bullseye.gpg" | in-target apt-key add -; \
    echo "deb http://enterprise.proxmox.com/debian/pve bullseye pve-enterprise" | in-target tee /etc/apt/sources.list.d/pve-enterprise.list; \
    in-target apt-get update; \
    in-target apt-get -y install proxmox-ve
```

## Automation Scripts

### 1. Node Preparation Script

```python
#!/usr/bin/env python3

import subprocess
import argparse

def prepare_node(hostname, ip_address, gateway):
    """Prepare a new Proxmox node for clustering"""
    
    commands = [
        f"pvecm create {hostname}",
        "systemctl restart pve-cluster",
        f"ip addr add {ip_address}/24 dev vmbr0",
        f"ip route add default via {gateway}",
        "systemctl restart networking"
    ]
    
    for cmd in commands:
        subprocess.run(cmd, shell=True, check=True)

def configure_storage(storage_type, storage_path):
    """Configure storage for the Proxmox node"""
    
    if storage_type == "ceph":
        setup_ceph()
    elif storage_type == "nfs":
        setup_nfs(storage_path)
    elif storage_type == "zfs":
        setup_zfs(storage_path)

def setup_ceph():
    """Setup Ceph storage"""
    commands = [
        "pveceph install",
        "pveceph init --network 192.168.1.0/24",
        "pveceph createmon"
    ]
    
    for cmd in commands:
        subprocess.run(cmd, shell=True, check=True)

def setup_nfs(storage_path):
    """Setup NFS storage"""
    subprocess.run(
        f"pvesm add nfs shared --path {storage_path} --server 192.168.1.100 --export /mnt/nfs",
        shell=True,
        check=True
    )

def setup_zfs(storage_path):
    """Setup ZFS storage"""
    commands = [
        f"zpool create tank {storage_path}",
        "pvesm add zfspool tank --pool tank"
    ]
    
    for cmd in commands:
        subprocess.run(cmd, shell=True, check=True)

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("--hostname", required=True)
    parser.add_argument("--ip", required=True)
    parser.add_argument("--gateway", required=True)
    parser.add_argument("--storage-type", choices=["ceph", "nfs", "zfs"])
    parser.add_argument("--storage-path")
    
    args = parser.parse_args()
    
    prepare_node(args.hostname, args.ip, args.gateway)
    if args.storage_type:
        configure_storage(args.storage_type, args.storage_path)
```

### 2. Post-Installation Configuration

```bash
#!/bin/bash

# Configure Proxmox repositories
cat > /etc/apt/sources.list.d/pve-enterprise.list << EOF
deb https://enterprise.proxmox.com/debian/pve bullseye pve-enterprise
EOF

# Update system
apt-get update && apt-get -y dist-upgrade

# Configure network bridge
cat > /etc/network/interfaces << EOF
auto lo
iface lo inet loopback

auto vmbr0
iface vmbr0 inet static
    address 192.168.1.10/24
    gateway 192.168.1.1
    bridge-ports eth0
    bridge-stp off
    bridge-fd 0
EOF

# Restart networking
systemctl restart networking

# Enable IOMMU for PCI passthrough
sed -i 's/GRUB_CMDLINE_LINUX_DEFAULT="quiet"/GRUB_CMDLINE_LINUX_DEFAULT="quiet intel_iommu=on"/' /etc/default/grub
update-grub

# Configure storage
pvesm add dir local-lvm --path /var/lib/vz
pvesm set local-lvm --content images,rootdir
```

## Monitoring and Maintenance

### 1. Health Check Script

```python
#!/usr/bin/env python3

import subprocess
import json
import smtplib
from email.message import EmailMessage

def check_node_health():
    """Check various health metrics of the Proxmox node"""
    
    checks = {
        "cpu_usage": "pvestatd cpu",
        "memory_usage": "pvestatd memory",
        "storage_usage": "pvesm status",
        "service_status": "systemctl status pve-cluster"
    }
    
    results = {}
    for check, command in checks.items():
        try:
            output = subprocess.check_output(command.split())
            results[check] = {"status": "ok", "output": output.decode()}
        except subprocess.CalledProcessError as e:
            results[check] = {"status": "error", "output": str(e)}
    
    return results

def send_alert(subject, body):
    """Send email alert for health issues"""
    
    msg = EmailMessage()
    msg.set_content(body)
    msg['Subject'] = subject
    msg['From'] = "monitoring@example.com"
    msg['To'] = "admin@example.com"
    
    with smtplib.SMTP('smtp.example.com', 587) as server:
        server.starttls()
        server.login("user", "password")
        server.send_message(msg)

def main():
    health_status = check_node_health()
    
    # Check for issues
    issues = []
    for check, result in health_status.items():
        if result["status"] == "error":
            issues.append(f"{check}: {result['output']}")
    
    # Send alert if issues found
    if issues:
        send_alert(
            "Proxmox Node Health Alert",
            "The following issues were detected:\n" + "\n".join(issues)
        )

if __name__ == "__main__":
    main()
```

## Troubleshooting

### Common Issues and Solutions

1. **PXE Boot Fails**
   - Check DHCP server configuration
   - Verify TFTP server is accessible
   - Ensure boot files are present

2. **Preseed Configuration Issues**
   - Validate preseed syntax
   - Check network connectivity
   - Review installation logs

3. **Proxmox Installation Problems**
   - Verify hardware compatibility
   - Check system requirements
   - Review repository access

## Best Practices

1. **Security**
   - Use strong passwords
   - Implement network segmentation
   - Regular security updates

2. **Backup**
   - Regular configuration backups
   - Test restore procedures
   - Document recovery process

3. **Maintenance**
   - Regular health checks
   - Performance monitoring
   - Update management

## Conclusion

Automating Proxmox deployment with PXE and Preseed significantly reduces setup time and ensures consistent configurations across nodes. Regular maintenance and monitoring ensure reliable operation.

## Additional Resources

- [Proxmox Documentation](https://pve.proxmox.com/wiki/Main_Page)
- [Debian Preseed Guide](https://www.debian.org/releases/stable/amd64/apb.en.html)
- [PXE Boot Documentation](https://wiki.syslinux.org/wiki/index.php?title=PXELINUX) 